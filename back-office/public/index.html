<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" contend="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
        <link href="/css/style.css" type="text/css" rel="stylesheet">

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

        <title>ANIMAL HOUSE</title>
    </head>
    <body>
        <div class="container">
          <!--TEST PRODUCT GET-->
          <h2>TEST PRODUCT GET</h2>
          <div class="row">
              <div class="col-md-3">
                <input type="text" id="productGetInput" placeholder="Insert product ID here">
                <button id="productGetButton">TRY</button>
              </div>
              <div class="col-md-9">
                <div class="row" id="productGetItems">
                </div>
              </div>            
          </div>
          <hr>
          <!--TEST PRODUCT POST-->
          <h2>TEST PRODUCT POST</h2>
          <div class="row">
            <div class="col-md-8">
                  <input type="text" id="productPostName" name="name" placeholder="Product name" required>
                  <input type="number" id="productPostPrice" name="price" placeholder="Price" required><br>
                  <textarea id="productPostDescription" name="description" placeholder="Type here your description" required></textarea><br>
                  <input type="text" id="productPostImage" name="image" placeholder="Product image URL" required>
                  <button id="productPostSend">SEND</button>
            </div>
            <div class="col-md-4" id="productPostResult"></div>
          </div>
          <hr>
          <!--TEST PRODUCT DELETE-->
          <h2>TEST PRODUCT DELETE</h2>
          <h3>ALL PRODUCTS:</h3>
          <div class="row" id="productDeleteItems">
                        
          </div>

        </div>

    </body>

    <script> 
      //!!! STA ROBA E' SOLO TEST, NON VA TENUTA !!!
      
      //TEMPLATE ITEM DA MOSTRARE
      const Item = ({ img, name, price, id, displaySize }) => `
        <div class="col${displaySize} item">
          <input type="image" src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Red_x.svg/2048px-Red_x.svg.png" class="item-remove" onclick=itemRemove("${id}")>
          <img class="item-image" src="${img}">
          <span class="item-title">${name}</span>
          <span class="item-price">${price}$</span><br><br>
        </div>
      `;
      
      // TEST PRODUCT GET
      $( "#productGetButton" ).click(function() {
        retrieveProduct('#productGetItems',$('#productGetInput').val());
      });


      // TEST PRODUCT POST
      $( "#productPostSend" ).click(function() {
        var headers = {
          "Content-Type": "application/json",                                                                                                
          "Access-Control-Origin": "*"
        }
        var data = {
          "name": $("#productPostName").val(),
          "price": $("#productPostPrice").val(),
          //"categoryId": "62f3c0540ac73a2bc4764da8",
          "description": $("#productPostDescription").val(),
          "animalTargets": [],
          "image": $("#productPostImage").val(),
        };
        fetch("/v1/market/products", {
          method: "POST",
          headers: headers,
          body:  JSON.stringify(data)
        }).then((response)=>response.json()).then(data=>{
          console.log(data);
          $("#productPostResult").html("<h3>Here is the product you added</h3>");
          $("#productPostResult").append([{displaySize: '-md-12',img: data.image, name: data.name, price: data.price, id: data._id}].map(Item));
          retrieveProduct('#productDeleteItems',"");
        }).catch(function(){
          alert("ERRORE");
        });
      });
      


      //TEST PRODUCT DELETE
      function itemRemove(id){
        if (confirm('Are you sure you want to remove the product '+id+'?')) {
          $.ajax({
            url: "/v1/market/products/"+id,
            type: 'DELETE',
            success: function(result) {
              //alert(result);
              retrieveProduct('#productDeleteItems',"");
            }
          });
        }        
      }

      $(document).ready(function(){
        retrieveProduct('#productDeleteItems',"");
      });

      function retrieveProduct(target,id){ //leave id blank to retrieve all products
        var url = "/v1/market/products/"+id;
        fetch(url).then((response)=>response.json()).then((data)=>{
          $(target).text("");
          
          data.forEach(function(el){
            $(target).append([{displaySize: '-md-3',img: el.image, name: el.name, price: el.price, id: el._id}].map(Item));
          });
        });
      }
      </script>
</html>